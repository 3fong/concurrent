## Java 并发编程

- 并行与并发

并发（Concurrent）:同一时间只能有一个线程执行的状态,存在资源竞争.当有多个线程在操作时，如果系统只有一个 CPU，则它根本不可能真正同时进行一个以上的线程，它只能把 CPU 运行时间划分成若干个时间段，再将时间段分配给各个线程执行，在一个时间段的线程代码运行时,其它线程处于挂起状态.这种方式我们称之为并发。

并行（Parallel）:同一时间多个线程一起执行的状态,不存在资源竞争.当系统有一个以上 CPU 时，则线程的操作有可能非并发。当一个 CPU 执行一个线程时，另一个 CPU 可以执行另一个线程，两个线程互不抢占 CPU资源，可以同时进行，这种方式我们称之为并行。

### 并发

并发的价值:

1. 充分利用硬件资源
2. 程序运行(处理请求)更快(核心价值)

并发衡量指标:并发数

TPS(Transactions Per Second): 每秒的事务处理数量，简而言之：用户请求页面->服务器进行处理->用户收到结果（这是一个TPS）    
QPS(Queries Per Second):每秒处理的查询数量：1000个用户同时查询一个商品，1000个用户同时可以查询到信息，那么我们的1000QPS/S

实现方式:

1. 提高硬件配置
2. 多线程

问题:

并发并不是一定能让程序更快,它有如下的限制:

1. 上下文切换
2. 死锁
3. 软硬的限制

并发问题

#### 上下文切换

1. 多线程
并发执行机制原理: 简单地说就是把一个处理器划分为若干个短的时间片，每个时间片依次轮流地执行处理各个应用程序，由于一个时间片很短，相对于一个应用程序来说，就好像是处理器在为自己单独服务一样，从而达到多个应用程序在同时进行的效果.

多线程:把操作系统中的这种并发执行机制原理运用在一个程序中，把一个程序划分为若干个子任务，多个子任务并发执行，每一个任务就是一个线程.Java中线程与系统线程是一对一的关系.

因此时间片的切换需要进行上下文切换,来获取线程的执行状态.这个切换会影响执行效率,也影响线程执行速度.也因此线程并不是越多越好,实际的执行效率受线程创建与上下文切换的影响.

2. 如何减少上下文切换

```
无锁编程(分段锁,通过规则约定降低线程资源竞争造成线程切换)
CAS算法(通过软件支持的原子性操作解决资源竞争问题,避免线程切换)
减少线程数
使用协程
```

协程:单线程多任务的共享资源管理方式.运行在线程之上，当一个协程执行完成后，可以选择主动让出，让另一个协程运行在当前线程之上。协程并没有增加线程数量，只是在线程的基础之上通过分时复用的方式运行多个协程，而且协程的切换在用户态完成，切换的代价比线程从用户态到内核态的代价小很多。
如:本身要创建100个线程的任务,可以创建10个线程,每个线程起10个协程来执行此任务.
```
在有大量IO操作业务的情况下，我们采用协程替换线程，可以到达很好的效果，一是降低了系统内存，二是减少了系统切换开销，因此系统的性能也会提升。    
在协程中尽量不要调用阻塞IO的方法，比如打印，读取文件，Socket接口等，除非改为异步调用的方式，并且协程只有在IO密集型的任务中才会发挥作用。    
协程只有和异步IO结合起来才能发挥出最大的威力。
```

jstatck;vmstat

#### 死锁

多个线程间互相持有锁,造成的占用资源无法释放的现象.

减少死锁方式
```
避免一个线程同时获取多个锁
避免一个线程在锁内同时占用多个资源,尽量保证每个锁只占用一个资源    
尝试使用定时锁    
数据库锁,加锁和解锁必须在一个数据库连接里,避免解锁失败
```


#### 软硬的限制

硬件限制:带宽,磁盘读写速度,内存,cpu处理速度;    
软件限制:数据库连接数,socket连接数

当资源限制较大时,并行由于相对于串行增加了上下文切换和资源调度时间,会更加慢.

解决方式:

1. 硬件限制.使用集群来扩展硬件资源.
2. 软件限制. 使用资源池,实现资源复用.
3. 多种限制因素时,要综合考虑限制点,评估最终的使用方式


### Java并发机制



































